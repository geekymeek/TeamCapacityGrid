<!DOCTYPE html>
<html>
<head>
    <title>TeamCapacityGrid</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"iteration",componentCls:"app",html:'<table><tr><td><div title="Create a task and assign it with estimate or enter initial capacity on the Team Status page."><b style="text-align:left;float:left;"></b></div></td><td><div><input type="button" style="text-align:right;float:right;" value="Refresh" onClick="javascript: app.onScopeChange();"/></div></td></tr></table>',comboboxConfig:{fieldLabel:"Select an Iteration:</div>",width:400},onScopeChange:function(){console.log("onScopeChange");var iOID=this.getContext().getTimeboxScope().getRecord().get("ObjectID");if(null===this.getContext().getTimeboxScope().getRecord())alert("You must specify a valid Iteration/Sprint. Unscheduled is not supported.");else{var storyStore=Ext.create("Rally.data.wsapi.Store",{model:"User Story",fetch:["Owner","PlanEstimate"],filters:this._getFilters(iOID),sorter:[{property:"Owner"}],pageSize:200});storyStore.load().then({success:function(stories){console.log("storyStore load promise success");var pointTotals={};_.each(stories,function(story){var ownerName,pointval;ownerName=null===story.get("Owner")?"no owner":story.get("Owner")._refObjectName,pointval=story.get("PlanEstimate")>0?story.get("PlanEstimate"):0,pointTotals[ownerName]?pointTotals[ownerName]+=pointval:pointTotals[ownerName]=pointval});var capacityStore=Ext.create("Rally.data.wsapi.Store",{model:"UserIterationCapacity",fetch:["User","Capacity","TaskEstimates","Load"],filters:this._getFilters(iOID),sorters:[{property:"User",direction:"ASC"}],pageSize:200});capacityStore.load().then({success:function(capacities){console.log("capacityStore load promise success");var gridrecords=_.map(capacities,function(capacity){return Ext.apply({PointEstimates:pointTotals[capacity.get("User")._refObjectName],PointLoad:6*pointTotals[capacity.get("User")._refObjectName]/capacity.get("Capacity"),UserName:capacity.get("User")._refObjectName,PointCapacity:Ext.util.Format.round(capacity.get("Capacity")/6,1)},capacity.getData())});this._myGrid&&this._myGrid.destroy(),this._myGrid=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygrid",store:Ext.create("Rally.data.custom.Store",{data:gridrecords}),showRowActionsColumn:!1,columnCfgs:[{text:"User",dataIndex:"UserName"},{text:"Point Load",width:60,align:"center",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.progressbar.ProgressBarTemplate",{percentDoneName:"PointLoad",calculateColorFn:function(recordData){var loadval=recordData.PointLoad;return colVal=.8>loadval?"#B2E3B6":1>=loadval?"#006600":1.25>loadval?"#FCB5B1":"#f61509"},generateLabelTextFn:function(recordData){return recordData.PointEstimates+" / "+recordData.PointCapacity}})},{text:"Task Est Load",width:60,align:"center",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.progressbar.ProgressBarTemplate",{percentDoneName:"Load",calculateColorFn:function(recordData){var loadval=recordData.Load;return colVal=.8>loadval?"#B2E3B6":1>=loadval?"#006600":1.25>loadval?"#FCB5B1":"#f61509"},generateLabelTextFn:function(recordData){return(null===recordData.TaskEstimates?0:recordData.TaskEstimates)+" / "+(null===recordData.Capacity?0:recordData.Capacity)}})}]}),app=this,this.add(this._myGrid)},failure:function(){console.log("capacityStore load promise failure")},scope:this})},failure:function(){console.log("load promise failure")},scope:this})}},_getFilters:function(iName){var filters=[];return filters.push({property:"Iteration.ObjectID",operator:"=",value:iName}),filters}});

            Rally.launchApp('CustomApp', {
                name:"TeamCapacityGrid",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
