<!DOCTYPE html>
<html>
<head>
    <title>TeamCapacityGrid</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"iteration",componentCls:"app",html:'<table><tr><td><div title="Create a task and assign it with estimate or enter initial capacity on the Team Status page."><b style="text-align:left;float:left;"></b></div></td><td><div><input type="button" style="text-align:right;float:right;" value="Refresh" onClick="javascript: app.onScopeChange();"/></div></td></tr></table>',comboboxConfig:{fieldLabel:"Select an Iteration:</div>",width:400},onScopeChange:function(){console.log("onScopeChange");var iOID=this.getContext().getTimeboxScope().getRecord().get("ObjectID");if(null===this.getContext().getTimeboxScope().getRecord())alert("You must specify a valid Iteration/Sprint. Unscheduled is not supported.");else{var capacityStore=Ext.create("Rally.data.wsapi.Store",{model:"UserIterationCapacity",fetch:["User","Capacity","TaskEstimates","Load"],filters:this._getFilters(iOID),sorters:[{property:"User",direction:"ASC"}],pageSize:200});capacityStore.load().then({success:function(capacities){console.log("capacityStore.load promise success");var storyStore=Ext.create("Rally.data.wsapi.Store",{model:"User Story",fetch:["Owner","PlanEstimate"],filters:this._getFilters(iOID),sorter:[{property:"Owner"}],pageSize:200});storyStore.load().then({success:function(stories){console.log("storyStore load promise success");var pointTotals=[],index;_.each(stories,function(story){var ownerName;ownerName=null===story.get("Owner")?"no owner":story.get("Owner")._refObjectName;var pointval;pointval=story.get("PlanEstimate")>0?story.get("PlanEstimate"):0;var c_uic=pointTotals.find(function findOwner(pointTotal){return pointTotal.name===ownerName});void 0===c_uic?(c_uic={},c_uic.name=ownerName,c_uic.pointEst=pointval,c_uic.taskEst=0,c_uic.capacityHrs=0,c_uic.capacityPts=0,c_uic.pointLoad=.01,c_uic.taskLoad=.01,pointTotals.push(c_uic)):c_uic.pointEst+=pointval}),console.log(pointTotals),pointTotals.forEach(function(currentValue){var result=capacityStore.findBy(function(record){return record.get("User")._refObjectName===currentValue.name?!0:!1});-1!==result&&(currentValue.capacityHrs=capacityStore.getAt(result).get("Capacity"),currentValue.taskEst=capacityStore.getAt(result).get("TaskEstimates"),currentValue.taskLoad=capacityStore.getAt(result).get("Load"),currentValue.capacityPts=Ext.util.Format.round(capacityStore.getAt(result).get("Capacity")/6,1),currentValue.pointLoad=6*currentValue.pointEst/capacityStore.getAt(result).get("Capacity"))}),console.log(pointTotals),this._myGrid&&this._myGrid.destroy();var cstore=Ext.create("Rally.data.custom.Store",{data:pointTotals});cstore.loadData(pointTotals),console.log(cstore),this._myGrid=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygrid",store:cstore,showRowActionsColumn:!1,columnCfgs:[{text:"User",dataIndex:"name"},{text:"Point Est Load",width:60,align:"center",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.progressbar.ProgressBarTemplate",{percentDoneName:"pointLoad",calculateColorFn:function(recordData){var loadval=recordData.pointLoad;return colVal=.8>loadval?"#B2E3B6":1>=loadval?"#006600":1.25>loadval?"#FCB5B1":"#f61509"},generateLabelTextFn:function(recordData){return recordData.pointEst+" / "+recordData.capacityPts}})},{text:"Task Est Load",width:60,align:"center",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.progressbar.ProgressBarTemplate",{percentDoneName:"taskLoad",calculateColorFn:function(recordData){var loadval=recordData.taskLoad;return colVal=.8>loadval?"#B2E3B6":1>=loadval?"#006600":1.25>loadval?"#FCB5B1":"#f61509"},generateLabelTextFn:function(recordData){return(null===recordData.taskEst?0:recordData.taskEst)+" / "+(null===recordData.capacityHrs?0:recordData.capacityHrs)}})}]}),app=this,this.add(this._myGrid)},failure:function(){console.log("storyStore.load promise failure")},scope:this})},failure:function(){console.log("capacityStore.load promise failure")},scope:this})}},_getFilters:function(iName){var filters=[];return filters.push({property:"Iteration.ObjectID",operator:"=",value:iName}),filters}});

            Rally.launchApp('CustomApp', {
                name:"TeamCapacityGrid",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
